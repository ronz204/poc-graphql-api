services:
  graphql:
    healthcheck:
      # Use curl to check if the application is healthy
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      # Wait for the database to be healthy
      postgres:
        condition: service_healthy
      # Wait for migrations to complete
      migrations:
        condition: service_completed_successfully
    develop:
      watch:
        # Sync source code changes
        - action: sync
          path: ./source
          target: /usr/src/app/source

        # Rebuild when Prisma models change
        - action: rebuild
          path: ./prisma/

        # Sync package.json for dependency tracking
        - action: sync
          path: ./package.json
          target: /usr/src/app/package.json

        # Rebuild when dependencies change
        - action: rebuild
          path: ./bun.lock
    networks:
      - graphql-network
    ports:
      - "3000:3000"
